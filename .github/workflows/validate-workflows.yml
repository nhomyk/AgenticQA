name: Workflow Validator & Auto-Fixer

# DEPRECATED: Workflow validation is now integrated into ci.yml as Phase -1
# This workflow is kept for manual validation only
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  validate-and-fix:
    runs-on: ubuntu-latest
    name: Validate & Auto-Fix Workflows
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install YAML validation tools
        run: npm install -g js-yaml

      - name: Detect YAML errors
        id: validate
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const yaml = require('js-yaml');

          const workflowDir = '.github/workflows';
          const files = fs.readdirSync(workflowDir)
            .filter(f => f.endsWith('.yml') || f.endsWith('.yaml'));
          
          let hasErrors = false;
          let errorDetails = [];

          files.forEach(file => {
            const filePath = path.join(workflowDir, file);
            try {
              const content = fs.readFileSync(filePath, 'utf8');
              yaml.load(content);
            } catch (err) {
              hasErrors = true;
              errorDetails.push({
                file: filePath,
                error: err.message,
                line: err.mark ? err.mark.line + 1 : 'unknown'
              });
            }
          });

          if (hasErrors) {
            console.log('::set-output name=has_errors::true');
            console.log('YAML Errors found:');
            errorDetails.forEach(e => {
              console.log(`  - ${e.file} (Line ${e.line}): ${e.error}`);
            });
            fs.writeFileSync('yaml-errors.json', JSON.stringify(errorDetails, null, 2));
          } else {
            console.log('::set-output name=has_errors::false');
            console.log('‚úÖ All workflows valid');
          }
          EOF

      - name: Auto-fix YAML errors
        if: steps.validate.outputs.has_errors == 'true'
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const yaml = require('js-yaml');

          console.log('\nüîß Attempting to auto-fix YAML errors...\n');

          const workflowDir = '.github/workflows';
          const files = fs.readdirSync(workflowDir)
            .filter(f => f.endsWith('.yml') || f.endsWith('.yaml'));
          
          let fixCount = 0;
          let errorFiles = [];

          files.forEach(file => {
            const filePath = path.join(workflowDir, file);
            const originalContent = fs.readFileSync(filePath, 'utf8');
            
            try {
              yaml.load(originalContent);
              console.log(`‚úÖ ${file} is valid`);
            } catch (err) {
              console.log(`‚ùå ${file} has errors at line ${err.mark ? err.mark.line + 1 : '?'}`);
              console.log(`   Error: ${err.message}`);
              errorFiles.push({file, content: originalContent, error: err});
            }
          });

          // Apply fixes to each errored file
          errorFiles.forEach(({file, content, error}) => {
            console.log(`\n   Applying auto-fixes to ${file}...`);
            
            let fixed = content;
            let fileFixCount = 0;

            // Fix 1: Improperly indented 'with:' key and nested properties
            // Pattern: "      with:" (6 spaces) should be "        with:" (8 spaces)
            // And nested properties need to align correctly
            if (fixed.match(/\n      with:/)) {
              console.log('   üîß Fix 1: Re-indenting "with:" keys and nested properties');
              
              // Move "with:" from 6 to 8 spaces
              fixed = fixed.replace(/\n      with:/g, '\n        with:');
              
              // Realign nested properties under "with:"
              const lines = fixed.split('\n');
              let inWithBlock = false;
              let withIndent = 0;
              
              for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (line.match(/^\s+with:\s*$/)) {
                  inWithBlock = true;
                  withIndent = line.search(/\S/);
                  continue;
                }
                
                if (inWithBlock) {
                  // Check if we've left the with block
                  if (line.match(/^\s*$/) || line.match(/^\s{0,7}\S/) || 
                      line.match(/^\s{0,8}(- |if:|needs:|runs-on:|steps:|jobs:)/)) {
                    inWithBlock = false;
                    continue;
                  }
                  
                  // Align properties under "with:"
                  if (line.match(/^\s+(name|path|retention-days|continue-on-error|tag|ref|token|node-version|file|level|pattern|scan-options|report-options):/)) {
                    const currentIndent = line.search(/\S/);
                    const targetIndent = withIndent + 2;
                    if (currentIndent !== targetIndent) {
                      lines[i] = ' '.repeat(targetIndent) + line.trimLeft();
                    }
                  }
                }
              }
              fixed = lines.join('\n');
              fileFixCount++;
            }

            // Fix 2: Tab characters to spaces
            if (fixed.includes('\t')) {
              console.log('   üîß Fix 2: Converting tabs to spaces');
              fixed = fixed.replace(/\t/g, '  ');
              fileFixCount++;
            }

            // Fix 3: Duplicate heredoc terminators
            if (fixed.match(/(\w+)_(\w+)\n\1_\2/)) {
              console.log('   üîß Fix 3: Removing duplicate heredoc terminators');
              fixed = fixed.replace(/(\w+)_(\w+)\n\1_\2/g, '$1_$2');
              fileFixCount++;
            }

            // Fix 4: Missing spaces after colons
            if (fixed.match(/^(\s+)(\w+):(?!\s)/m)) {
              console.log('   üîß Fix 4: Adding missing spaces after colons');
              fixed = fixed.replace(/^(\s+)(\w+):(?!\s)/gm, '$1$2: ');
              fileFixCount++;
            }

            // Verify fix worked
            try {
              yaml.load(fixed);
              console.log(`   ‚úÖ All fixes successful! Applied ${fileFixCount} fix(es)`);
              fs.writeFileSync(path.join(workflowDir, file), fixed);
              fixCount += fileFixCount;
            } catch (err2) {
              console.log(`   ‚ùå Auto-fix incomplete - remaining error: ${err2.message}`);
              console.log(`      Line ${err2.mark ? err2.mark.line + 1 : '?'}`);
            }
          });

          console.log(`\nüìä Total files with errors: ${errorFiles.length}`);
          console.log(`üìä Total fixes applied: ${fixCount}\n`);

          if (fixCount === 0 && errorFiles.length > 0) {
            console.log('‚ö†Ô∏è  Could not auto-fix all errors - manual intervention needed');
            process.exit(1);
          }
          EOF

      - name: Commit and push fixes
        if: steps.validate.outputs.has_errors == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add '.github/workflows/*.yml' '.github/workflows/*.yaml'
          
          STATUS=$(git status --porcelain)
          if [ -z "$STATUS" ]; then
            echo "‚úÖ No changes to commit"
          else
            echo "üìù Committing workflow fixes..."
            git commit -m "fix: Auto-fix YAML workflow syntax errors"
            git push origin main
            echo "‚úÖ Fixes pushed - triggering new workflow run"
          fi

      - name: Trigger new workflow run
        if: steps.validate.outputs.has_errors == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              ref: 'main'
            }).then(res => {
              console.log('‚úÖ New workflow triggered');
            }).catch(err => {
              console.log('‚ö†Ô∏è Could not trigger workflow:', err.message);
            });

      - name: Success summary
        if: steps.validate.outputs.has_errors == 'false'
        run: echo "‚úÖ All workflows valid - CI will proceed normally"
