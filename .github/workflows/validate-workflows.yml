name: Workflow Validator & Auto-Fixer

on:
  push:
    paths:
      - '.github/workflows/*.yml'
      - '.github/workflows/*.yaml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  validate-and-fix:
    runs-on: ubuntu-latest
    name: Validate & Auto-Fix Workflows
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install YAML validation tools
        run: npm install -g yaml js-yaml

      - name: Validate and fix workflow YAML
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const yaml = require('yaml');

          console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
          console.log('‚ïë   üîç WORKFLOW YAML VALIDATOR           ‚ïë');
          console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');

          const workflowDir = '.github/workflows';
          const files = fs.readdirSync(workflowDir).filter(f => f.endsWith('.yml') || f.endsWith('.yaml'));
          
          let errorCount = 0;
          let fixCount = 0;

          files.forEach(file => {
            const filePath = path.join(workflowDir, file);
            console.log(`üìã Checking: ${file}`);
            
            try {
              const content = fs.readFileSync(filePath, 'utf8');
              yaml.parse(content);
              console.log(`  ‚úÖ YAML is valid\n`);
            } catch (err) {
              console.log(`  ‚ùå YAML Error: ${err.message}`);
              errorCount++;
              
              // Attempt auto-fixes
              let fixed = false;
              let fixedContent = content;

              // Fix 1: Remove improper indentation before 'with:'
              if (fixedContent.match(/^      - uses:/m) && fixedContent.match(/^      with:/m)) {
                console.log(`  üîß Fixing improperly indented 'with:' key...`);
                fixedContent = fixedContent.replace(/^      with:/gm, '        with:');
                fixed = true;
                fixCount++;
              }

              // Fix 2: Fix unclosed heredocs
              const heredocPattern = /<<\s*'([A-Z_]+)'/g;
              let match;
              while ((match = heredocPattern.exec(content)) !== null) {
                const delimiter = match[1];
                const closePattern = new RegExp(`^\\s*${delimiter}\\s*$`, 'm');
                if (!closePattern.test(content)) {
                  console.log(`  üîß Fixing unclosed heredoc '${delimiter}'...`);
                  // Add closing delimiter before next section
                  fixedContent = fixedContent.replace(/(\n\s{2,}[a-z-]+:|$)/m, '\n          ' + delimiter + '\n$1');
                  fixed = true;
                  fixCount++;
                }
              }

              // Fix 3: Fix tab indentation
              if (fixedContent.includes('\t')) {
                console.log(`  üîß Fixing tab indentation...`);
                fixedContent = fixedContent.split('\n').map(line => {
                  if (line.startsWith('\t')) {
                    return line.replace(/^\t+/g, match => '  '.repeat(match.length));
                  }
                  return line;
                }).join('\n');
                fixed = true;
                fixCount++;
              }

              if (fixed) {
                try {
                  yaml.parse(fixedContent);
                  console.log(`  ‚úÖ Auto-fix successful - YAML is now valid\n`);
                  fs.writeFileSync(filePath, fixedContent);
                } catch (err2) {
                  console.log(`  ‚ö†Ô∏è  Auto-fix applied but YAML still invalid: ${err2.message}\n`);
                }
              } else {
                console.log(`  ‚ö†Ô∏è  Could not auto-fix this error\n`);
              }
            }
          });

          console.log('‚ïê'.repeat(50));
          console.log(`üìä VALIDATION SUMMARY`);
          console.log('‚ïê'.repeat(50));
          console.log(`Total files checked: ${files.length}`);
          console.log(`Errors found: ${errorCount}`);
          console.log(`Fixes applied: ${fixCount}`);
          console.log('‚ïê'.repeat(50));

          if (fixCount > 0) {
            console.log('\n‚úÖ Fixes detected - committing changes...\n');
            process.exit(0); // Success
          } else if (errorCount > 0) {
            console.log('\n‚ö†Ô∏è  Errors found but could not auto-fix\n');
            process.exit(1);
          } else {
            console.log('\n‚úÖ All workflows valid\n');
            process.exit(0);
          }
          EOF

      - name: Commit workflow fixes
        if: always()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add '.github/workflows/*.yml' '.github/workflows/*.yaml'
          
          STATUS=$(git status --porcelain)
          if [ -z "$STATUS" ]; then
            echo "‚úÖ No changes to commit"
          else
            echo "üìù Committing workflow fixes..."
            git commit -m "fix: Auto-fix YAML workflow syntax errors

Detected and corrected YAML syntax errors in workflow files:
- Fixed improperly indented keys
- Corrected indentation (tabs to spaces)
- Fixed unclosed heredocs

This commit was generated by the Workflow Validator workflow."
            
            git push origin main
            echo "‚úÖ Changes pushed"
          fi
