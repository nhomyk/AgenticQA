name: Workflow Validator & Auto-Fixer

on:
  push:
    paths:
      - '.github/workflows/*.yml'
      - '.github/workflows/*.yaml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  validate-and-fix:
    runs-on: ubuntu-latest
    name: Validate & Auto-Fix Workflows
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install YAML validation tools
        run: npm install -g js-yaml

      - name: Detect YAML errors
        id: validate
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const yaml = require('js-yaml');

          const workflowDir = '.github/workflows';
          const files = fs.readdirSync(workflowDir)
            .filter(f => f.endsWith('.yml') || f.endsWith('.yaml'));
          
          let hasErrors = false;
          let errorDetails = [];

          files.forEach(file => {
            const filePath = path.join(workflowDir, file);
            try {
              const content = fs.readFileSync(filePath, 'utf8');
              yaml.load(content);
            } catch (err) {
              hasErrors = true;
              errorDetails.push({
                file: filePath,
                error: err.message,
                line: err.mark ? err.mark.line + 1 : 'unknown'
              });
            }
          });

          if (hasErrors) {
            console.log('::set-output name=has_errors::true');
            console.log('YAML Errors found:');
            errorDetails.forEach(e => {
              console.log(`  - ${e.file} (Line ${e.line}): ${e.error}`);
            });
            fs.writeFileSync('yaml-errors.json', JSON.stringify(errorDetails, null, 2));
          } else {
            console.log('::set-output name=has_errors::false');
            console.log('‚úÖ All workflows valid');
          }
          EOF

      - name: Auto-fix YAML errors
        if: steps.validate.outputs.has_errors == 'true'
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const yaml = require('js-yaml');

          console.log('\nüîß Attempting to auto-fix YAML errors...\n');

          const workflowDir = '.github/workflows';
          const files = fs.readdirSync(workflowDir)
            .filter(f => f.endsWith('.yml') || f.endsWith('.yaml'));
          
          let fixCount = 0;

          files.forEach(file => {
            const filePath = path.join(workflowDir, file);
            try {
              const content = fs.readFileSync(filePath, 'utf8');
              yaml.load(content);
              console.log(`‚úÖ ${file} is valid`);
            } catch (err) {
              console.log(`‚ùå ${file} has errors - attempting fix...`);
              
              let fixed = content;
              
              // Fix 1: Improperly indented 'with:' key
              if (fixed.includes('- uses:') && /^      with:/m.test(fixed)) {
                console.log('  üîß Fixing improperly indented "with:" key');
                fixed = fixed.replace(/^      with:/gm, '        with:');
                fixCount++;
              }

              // Fix 2: Tab indentation
              if (fixed.includes('\t')) {
                console.log('  üîß Converting tabs to spaces');
                fixed = fixed.split('\n').map(line => {
                  if (line.startsWith('\t')) {
                    return line.replace(/^\t+/g, match => '  '.repeat(match.length));
                  }
                  return line;
                }).join('\n');
                fixCount++;
              }

              // Fix 3: Multi-line strings in shell commands
              if (fixed.includes('git commit -m "') && fixed.match(/git commit -m ".*\n.*"/)) {
                console.log('  üîß Simplifying multi-line commit messages');
                fixed = fixed.replace(/git commit -m "([^"]*\n[^"]*)"/gs, (match) => {
                  const msg = match.match(/"([^"]*)"/s)[1].split('\n')[0];
                  return `git commit -m "${msg}"`;
                });
                fixCount++;
              }

              // Verify fix worked
              try {
                yaml.load(fixed);
                console.log('  ‚úÖ Fix successful!');
                fs.writeFileSync(filePath, fixed);
              } catch (err2) {
                console.log(`  ‚ö†Ô∏è  Auto-fix incomplete: ${err2.message}`);
              }
            }
          });

          console.log(`\nüìä Total fixes applied: ${fixCount}\n`);

          if (fixCount > 0) {
            process.exit(0); // Signal that fixes were applied
          }
          EOF

      - name: Commit and push fixes
        if: steps.validate.outputs.has_errors == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add '.github/workflows/*.yml' '.github/workflows/*.yaml'
          
          STATUS=$(git status --porcelain)
          if [ -z "$STATUS" ]; then
            echo "‚úÖ No changes to commit"
          else
            echo "üìù Committing workflow fixes..."
            git commit -m "fix: Auto-fix YAML workflow syntax errors"
            git push origin main
            echo "‚úÖ Fixes pushed - triggering new workflow run"
          fi

      - name: Trigger new workflow run
        if: steps.validate.outputs.has_errors == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              ref: 'main'
            }).then(res => {
              console.log('‚úÖ New workflow triggered');
            }).catch(err => {
              console.log('‚ö†Ô∏è Could not trigger workflow:', err.message);
            });

      - name: Success summary
        if: steps.validate.outputs.has_errors == 'false'
        run: echo "‚úÖ All workflows valid - CI will proceed normally"
