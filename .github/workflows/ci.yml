on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security:
    runs-on: ubuntu-latest
    name: Security Scanning
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run npm audit
        run: npm audit --audit-level=moderate
      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run ESLint
        run: npx eslint . --ext .js

  unit-test:
    needs: [security, lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run Jest unit tests and coverage
        run: npx jest --coverage

  test-playwright:
    needs: [security, lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      - name: Run Playwright tests
        run: npx playwright test

  test-vitest:
    needs: [security, lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run Vitest
        run: npm run test:vitest -- --run --coverage

  test-cypress:
    needs: [security, lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Start server
        run: npm start &
      - name: Wait for server to start
        run: sleep 3
      - name: Run Cypress tests
        run: npm run test:cypress

  agent-workflow:
    needs: [security, lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium
      - name: Start server
        run: npm start &
      - name: Wait for server to start
        run: sleep 3
      - name: Run agent on Yahoo (https://www.yahoo.com)
        run: npm run agent "https://www.yahoo.com"
        continue-on-error: true
      - name: Run agent on CBS (https://www.cbs.com)
        run: npm run agent "https://www.cbs.com"
        continue-on-error: true
      - name: Run agent on GitHub (https://www.github.com)
        run: npm run agent "https://www.github.com"
        continue-on-error: true
      - name: Agent workflow summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  AgenticQA Agent Workflow Complete    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Agent executed on 3 external URLs:"
          echo "  1. https://www.yahoo.com"
          echo "  2. https://www.cbs.com"
          echo "  3. https://www.github.com"
          echo ""
          echo "ğŸ“Š For each URL, the agent:"
          echo "  â€¢ Scanned codebase structure"
          echo "  â€¢ Submitted URL to frontend for QA analysis"
          echo "  â€¢ Analyzed scan results"
          echo "  â€¢ Generated 3 AI-powered recommendations"
          echo ""
          echo "ğŸ’¡ Recommendations cover:"
          echo "  â€¢ Accessibility improvements"
          echo "  â€¢ Performance optimization"
          echo "  â€¢ Testing & coverage expansion"

  sre-agent:
    runs-on: ubuntu-latest
    needs: [lint, unit-test, test-playwright, test-vitest, test-cypress, agent-workflow]
    if: ${{ always() }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Set up git credentials
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://${{ secrets.GH_PAT }}@github.com/${{ github.repository }}
      - name: Run Agentic SRE Engineer
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
        run: |
          node agentic_sre_engineer.js
      - name: Commit and push changes (if any)
        run: |
          git add .
          git diff --cached --quiet || git commit -m "fix: auto-fix by Agentic SRE Engineer"
          git push || true