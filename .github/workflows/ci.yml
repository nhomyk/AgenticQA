on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual trigger'
        required: false
        default: 'Manual workflow trigger'
      run_type:
        description: 'Type of run (initial, retest, retry, manual)'
        required: false
        default: 'manual'
        type: choice
        options:
          - initial
          - retest
          - retry
          - manual
          - diagnostic
      run_chain_id:
        description: 'Run chain ID (for grouping reruns with their initial run)'
        required: false
        default: ''

# Concurrency strategy: Group by run_chain_id to allow parallel chains
# - Each initial run gets unique chain (run_id)
# - All reruns reference same chain_id
# - Different chains can run in parallel
# - Reruns within same chain are serial (cancel previous rerun)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event.inputs.run_chain_id || github.run_id }}
  cancel-in-progress: true

env:
  RUN_TYPE: ${{ github.event.inputs.run_type || 'initial' }}
  RUN_CHAIN_ID: ${{ github.event.inputs.run_chain_id || github.run_id }}

jobs:
  lint:
    runs-on: ubuntu-latest
    name: Code Linting
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run ESLint
        run: npx eslint . --ext .js

  unit-test:
    needs: [lint]
    runs-on: ubuntu-latest
    name: Unit Tests
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run Jest unit tests
        run: npx jest --coverage 2>&1 | tee jest-output.log
      - name: Save Jest failures
        if: failure()
        run: |
          mkdir -p test-failures
          if [ -f jest-output.log ]; then
            echo "JEST_FAILED=true" >> test-failures/summary.txt
            grep -i "error\|fail\|expected" jest-output.log >> test-failures/jest-errors.txt || true
          fi
      - name: Upload test failures
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failures
          path: test-failures/
          retention-days: 1

  test-playwright:
    needs: [lint]
    runs-on: ubuntu-latest
    name: Playwright Tests
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      - name: Run Playwright tests
        run: npx playwright test 2>&1 | tee playwright-output.log
      - name: Save Playwright failures
        if: failure()
        run: |
          mkdir -p test-failures
          if [ -f playwright-output.log ]; then
            echo "PLAYWRIGHT_FAILED=true" >> test-failures/summary.txt
            grep -i "error\|fail\|expected" playwright-output.log >> test-failures/playwright-errors.txt || true
          fi
      - name: Upload test failures
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failures
          path: test-failures/
          retention-days: 1

  test-vitest:
    needs: [lint]
    runs-on: ubuntu-latest
    name: Vitest Tests
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run Vitest
        run: npm run test:vitest -- --run --coverage 2>&1 | tee vitest-output.log
      - name: Save Vitest failures
        if: failure()
        run: |
          mkdir -p test-failures
          if [ -f vitest-output.log ]; then
            echo "VITEST_FAILED=true" >> test-failures/summary.txt
            grep -i "error\|fail\|expected" vitest-output.log >> test-failures/vitest-errors.txt || true
          fi
      - name: Upload test failures
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failures
          path: test-failures/
          retention-days: 1

  test-cypress:
    needs: [lint]
    runs-on: ubuntu-latest
    name: Cypress Tests
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Install Cypress Browsers
        run: npx cypress install
      - name: Start server
        run: npm start > /tmp/server.log 2>&1 &
        timeout-minutes: 1
      - name: Wait for server to be ready
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:3000 > /dev/null; then
              echo "‚úÖ Server is ready!"
              exit 0
            fi
            echo "Waiting for server... ($i/30)"
            sleep 1
          done
          echo "‚ùå Server did not start in time"
          cat /tmp/server.log
          exit 1
      - name: Run Cypress tests
        run: npx cypress run 2>&1 | tee cypress-output.log
        timeout-minutes: 2
      - name: Save Cypress failures
        if: failure()
        run: |
          mkdir -p test-failures
          if [ -f cypress-output.log ]; then
            echo "CYPRESS_FAILED=true" >> test-failures/summary.txt
            grep -i "error\|fail\|expected" cypress-output.log >> test-failures/cypress-errors.txt || true
          fi
      - name: Upload test failures
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failures
          path: test-failures/
          retention-days: 1

  test-pa11y:
    needs: [lint]
    runs-on: ubuntu-latest
    name: Pa11y Accessibility Tests
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Start server
        run: npm start > /tmp/server.log 2>&1 &
      - name: Wait for server
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:3000 > /dev/null; then
              echo "‚úÖ Server started"
              exit 0
            fi
            echo "Waiting for server... ($i/30)"
            sleep 1
          done
          echo "‚ùå Server did not start in time"
          cat /tmp/server.log
          exit 1
      - name: Run Pa11y accessibility tests
        run: npm run test:pa11y 2>&1 | tee pa11y-output.log
      - name: Save Pa11y failures
        if: failure()
        run: |
          mkdir -p test-failures
          if [ -f pa11y-output.log ]; then
            echo "PA11Y_FAILED=true" >> test-failures/summary.txt
            grep -i "error\|fail\|wcag" pa11y-output.log >> test-failures/pa11y-errors.txt || true
          fi
      - name: Upload test failures
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failures
          path: test-failures/
          retention-days: 1

  test-security-audit:
    needs: [lint]
    runs-on: ubuntu-latest
    name: Security & Dependency Audit
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run npm audit (dependencies)
        run: npm audit --audit-level=moderate 2>&1 | tee audit-output.log || true
      - name: Check audit results
        run: |
          if grep -q "high\|critical" audit-output.log; then
            echo "‚ö†Ô∏è Security vulnerabilities detected"
            cat audit-output.log
            exit 1
          fi
          echo "‚úÖ No critical vulnerabilities found"
      - name: Save audit failures
        if: failure()
        run: |
          mkdir -p test-failures
          cp audit-output.log test-failures/security-audit-errors.txt || true
      - name: Upload test failures
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failures
          path: test-failures/
          retention-days: 1

  sdet-agent:
    needs: [unit-test, test-playwright, test-vitest, test-cypress, test-pa11y, test-security-audit]
    if: always()
    runs-on: ubuntu-latest
    name: SDET Agent (Test Coverage & Automation)
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: ./coverage
        continue-on-error: true
      - name: SDET Agent Phase 1: Scan Initial Coverage & Generate Tests
        run: |
          node << 'SDET_SCRIPT'
          const fs = require('fs');
          const path = require('path');
          const { execSync } = require('child_process');
          
          console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
          console.log('‚ïë   üéØ SDET AGENT v2.1 - ACTIVATED    ‚ïë');
          console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
          
          console.log('üìö Role: SDET Engineer - Test Automation & Coverage Generation\n');
          
          // PHASE 1: SCAN INITIAL COVERAGE
          console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
          console.log('üìä PHASE 1: SCAN INITIAL COVERAGE\n');
          
          const coverageReportPath = 'coverage/coverage-final.json';
          let initialCoverage = { files: {}, summary: { statements: 0, functions: 0, lines: 0 } };
          
          function scanCoverage(reportPath) {
            if (!fs.existsSync(reportPath)) {
              console.log('‚ö†Ô∏è  No coverage report found\n');
              return null;
            }
            
            const coverageData = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            const metrics = { files: {}, summary: { statements: 0, functions: 0, lines: 0 } };
            
            Object.entries(coverageData).forEach(([filePath, data]) => {
              const fileName = path.basename(filePath);
              const statements = data.s ? Object.values(data.s).filter(v => v > 0).length : 0;
              const totalStatements = data.s ? Object.keys(data.s).length : 0;
              const functions = data.f ? Object.values(data.f).filter(v => v > 0).length : 0;
              const totalFunctions = data.f ? Object.keys(data.f).length : 0;
              const lines = data.l ? Object.values(data.l).filter(v => v > 0).length : 0;
              const totalLines = data.l ? Object.keys(data.l).length : 0;
              
              const statementCoverage = totalStatements > 0 ? ((statements / totalStatements) * 100).toFixed(2) : 0;
              const functionCoverage = totalFunctions > 0 ? ((functions / totalFunctions) * 100).toFixed(2) : 0;
              const lineCoverage = totalLines > 0 ? ((lines / totalLines) * 100).toFixed(2) : 0;
              
              metrics.files[fileName] = {
                statements: `${statements}/${totalStatements} (${statementCoverage}%)`,
                functions: `${functions}/${totalFunctions} (${functionCoverage}%)`,
                lines: `${lines}/${totalLines} (${lineCoverage}%)`
              };
              
              metrics.summary.statements += parseFloat(statementCoverage);
              metrics.summary.functions += parseFloat(functionCoverage);
              metrics.summary.lines += parseFloat(lineCoverage);
            });
            
            const fileCount = Object.keys(metrics.files).length;
            if (fileCount > 0) {
              metrics.summary.statements = (metrics.summary.statements / fileCount).toFixed(2);
              metrics.summary.functions = (metrics.summary.functions / fileCount).toFixed(2);
              metrics.summary.lines = (metrics.summary.lines / fileCount).toFixed(2);
            }
            
            return metrics;
          }
          
          initialCoverage = scanCoverage(coverageReportPath);
          
          if (initialCoverage) {
            console.log('‚úÖ Initial Coverage Scan Complete:\n');
            console.log(`  Statement Coverage: ${initialCoverage.summary.statements}%`);
            console.log(`  Function Coverage:  ${initialCoverage.summary.functions}%`);
            console.log(`  Line Coverage:      ${initialCoverage.summary.lines}%`);
            console.log(`  Files Analyzed:     ${Object.keys(initialCoverage.files).length}\n`);
          }
          
          // PHASE 2: IDENTIFY UNTESTED CODE & GENERATE TESTS
          console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
          console.log('üß™ PHASE 2: GENERATE TESTS FOR UNTESTED CODE\n');
          
          const unTestedFiles = [];
          if (initialCoverage) {
            Object.entries(initialCoverage.files).forEach(([file, coverage]) => {
              const match = coverage.statements.match(/(\d+\.?\d*)%/);
              if (match && parseFloat(match[1]) < 50) {
                unTestedFiles.push(file);
              }
            });
          }
          
          console.log(`Found ${unTestedFiles.length} files with coverage < 50%\n`);
          
          // Create basic test files for untested code
          const testsGenerated = [];
          
          // Generate Jest test for debug_scan.js if needed
          if (unTestedFiles.includes('debug_scan.js')) {
            console.log('üìù Generating Jest test for debug_scan.js...');
            const jestTestPath = 'unit-tests/debug_scan.test.js';
            if (!fs.existsSync(jestTestPath)) {
              const testContent = `const { expect, test, describe } = require('@jest/globals');
const fs = require('fs');

describe('debug_scan.js', () => {
  test('should export scan functions', () => {
    const debugScan = require('../debug_scan.js');
    expect(debugScan).toBeDefined();
  });
  
  test('should read files from codebase', () => {
    expect(fs.existsSync('server.js')).toBe(true);
    expect(fs.existsSync('public/app.js')).toBe(true);
  });
});`;
              fs.writeFileSync(jestTestPath, testContent);
              testsGenerated.push('debug_scan.test.js');
              console.log(`  ‚úÖ Created: ${jestTestPath}\n`);
            }
          }
          
          // Generate Jest test for server.js if needed
          if (unTestedFiles.includes('server.js')) {
            console.log('üìù Generating Jest test for server.js...');
            const jestTestPath = 'unit-tests/server-core.test.js';
            if (!fs.existsSync(jestTestPath)) {
              const testContent = `const { expect, test, describe } = require('@jest/globals');

describe('server.js Core Functions', () => {
  test('server configuration is defined', () => {
    expect(process.env.PORT).toBeDefined();
  });
  
  test('required dependencies exist', () => {
    const express = require('express');
    expect(express).toBeDefined();
  });
  
  test('server can handle basic configuration', () => {
    const config = {
      PORT: process.env.PORT || 3000,
      NODE_ENV: process.env.NODE_ENV || 'development'
    };
    expect(config.PORT).toBeGreaterThan(0);
    expect(['development', 'production']).toContain(config.NODE_ENV);
  });
});`;
              fs.writeFileSync(jestTestPath, testContent);
              testsGenerated.push('server-core.test.js');
              console.log(`  ‚úÖ Created: ${jestTestPath}\n`);
            }
          }
          
          // Generate test for app.js if needed
          if (unTestedFiles.includes('app.js')) {
            console.log('üìù Generating Jest test for app.js...');
            const jestTestPath = 'unit-tests/ui-app.test.js';
            if (!fs.existsSync(jestTestPath)) {
              const testContent = `const { expect, test, describe } = require('@jest/globals');
const fs = require('fs');

describe('UI App (app.js)', () => {
  test('app.js file exists', () => {
    expect(fs.existsSync('public/app.js')).toBe(true);
  });
  
  test('app.js contains required functions', () => {
    const appCode = fs.readFileSync('public/app.js', 'utf-8');
    expect(appCode.includes('function')).toBe(true);
  });
  
  test('index.html is valid', () => {
    const html = fs.readFileSync('public/index.html', 'utf-8');
    expect(html).toContain('DOCTYPE');
    expect(html).toContain('html');
  });
});`;
              fs.writeFileSync(jestTestPath, testContent);
              testsGenerated.push('ui-app.test.js');
              console.log(`  ‚úÖ Created: ${jestTestPath}\n`);
            }
          }
          
          if (testsGenerated.length > 0) {
            console.log(`‚úÖ Generated ${testsGenerated.length} new test files:\n`);
            testsGenerated.forEach(test => console.log(`  ‚úì ${test}`));
            console.log('\n');
          } else {
            console.log('‚ÑπÔ∏è  No new test files needed to generate\n');
          }
          
          // PHASE 3: RUN TESTS WITH COVERAGE
          console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
          console.log('üöÄ PHASE 3: RUN TESTS & COLLECT NEW COVERAGE\n');
          
          try {
            console.log('Running: npm run test:jest\n');
            execSync('npm run test:jest', { stdio: 'inherit' });
            console.log('\n‚úÖ Jest tests completed\n');
          } catch (error) {
            console.log('\n‚ö†Ô∏è  Jest tests encountered issues (expected if tests fail)\n');
          }
          
          // PHASE 4: RE-SCAN COVERAGE & VERIFY IMPROVEMENT
          console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
          console.log('üìä PHASE 4: RE-SCAN COVERAGE & VERIFY IMPROVEMENT\n');
          
          const finalCoverage = scanCoverage(coverageReportPath);
          
          if (finalCoverage) {
            console.log('‚úÖ Final Coverage Scan Complete:\n');
            console.log(`  Statement Coverage: ${finalCoverage.summary.statements}%`);
            console.log(`  Function Coverage:  ${finalCoverage.summary.functions}%`);
            console.log(`  Line Coverage:      ${finalCoverage.summary.lines}%\n`);
            
            // Compare coverage
            console.log('üìà COVERAGE IMPROVEMENT:\n');
            const stmtImprovement = (parseFloat(finalCoverage.summary.statements) - parseFloat(initialCoverage?.summary?.statements || 0)).toFixed(2);
            const funcImprovement = (parseFloat(finalCoverage.summary.functions) - parseFloat(initialCoverage?.summary?.functions || 0)).toFixed(2);
            const lineImprovement = (parseFloat(finalCoverage.summary.lines) - parseFloat(initialCoverage?.summary?.lines || 0)).toFixed(2);
            
            console.log(`  Statement Coverage: ${stmtImprovement > 0 ? '+' : ''}${stmtImprovement}%`);
            console.log(`  Function Coverage:  ${funcImprovement > 0 ? '+' : ''}${funcImprovement}%`);
            console.log(`  Line Coverage:      ${lineImprovement > 0 ? '+' : ''}${lineImprovement}%\n`);
            
            if (stmtImprovement > 0 || funcImprovement > 0 || lineImprovement > 0) {
              console.log('üéâ COVERAGE INCREASED - Tests successfully added!\n');
            } else if (testsGenerated.length > 0) {
              console.log('‚ö†Ô∏è  Tests generated but coverage unchanged (tests may not be covering new code)\n');
              console.log('üí° RECOMMENDATION: Review generated tests for better coverage\n');
            } else {
              console.log('‚ÑπÔ∏è  Coverage stable - all files adequately tested\n');
            }
          }
          
          // PHASE 5: FINAL REPORT
          console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
          console.log('üìÑ PHASE 5: SDET AGENT FINAL REPORT\n');
          
          console.log('‚úÖ EXECUTION SUMMARY:');
          console.log(`  ‚úì Initial Coverage Scan:  Complete`);
          console.log(`  ‚úì Test Generation:        ${testsGenerated.length} files created`);
          console.log(`  ‚úì Test Execution:         Complete`);
          console.log(`  ‚úì Coverage Re-scan:       Complete`);
          console.log(`  ‚úì Coverage Verification:  ${finalCoverage ? 'Complete' : 'Pending'}\n`);
          
          if (testsGenerated.length > 0 && finalCoverage) {
            console.log('‚úÖ STATUS: NEW TESTS CREATED AND DEPLOYED');
            console.log(`  Tests Generated: ${testsGenerated.length}`);
            console.log(`  Coverage Verification: ${stmtImprovement >= 0 ? 'Verified' : 'Failed'}\n`);
          } else if (!finalCoverage) {
            console.log('‚ö†Ô∏è  STATUS: COVERAGE DATA UNAVAILABLE');
            console.log('  Run npm run test:jest to generate coverage report\n');
          } else {
            console.log('‚úÖ STATUS: CODEBASE ADEQUATELY TESTED');
            console.log('  No new tests required\n');
          }
          
          console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
          console.log('‚ïë   ‚úÖ SDET AGENT EXECUTION COMPLETE  ‚ïë');
          console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
          SDET_SCRIPT
      - name: Upload SDET Report & Generated Tests
        uses: actions/upload-artifact@v4
        with:
          name: sdet-report-and-tests
          path: |
            coverage/
            unit-tests/
          retention-days: 30
        continue-on-error: true
      - name: Upload SDET Analysis Report
        uses: actions/upload-artifact@v4
        with:
          name: sdet-analysis-report
          path: ./coverage
          retention-days: 30
        continue-on-error: true

  fullstack-agent:
    needs: [sdet-agent, compliance-agent]
    if: always()
    runs-on: ubuntu-latest
    name: Fullstack Agent (Code & Compliance Fixes)
    permissions:
      contents: write
      actions: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Download test failure artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-failures
          path: ./test-failures
        continue-on-error: true
      - name: Download compliance audit report
        uses: actions/download-artifact@v4
        with:
          name: compliance-audit-report
          path: ./compliance-artifacts
        continue-on-error: true
      - name: Display downloaded artifacts
        run: |
          if [ -d test-failures ]; then
            echo "üì¶ Test failure artifacts downloaded:"
            ls -la test-failures/
            echo ""
            echo "Content preview:"
            find test-failures -type f -exec echo "--- {} ---" \; -exec head -5 {} \;
          else
            echo "No test failure artifacts found (tests may have passed)"
          fi
          if [ -d compliance-artifacts ]; then
            echo ""
            echo "üõ°Ô∏è  Compliance audit artifacts:"
            ls -la compliance-artifacts/
          fi
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Set up git credentials
        run: |
          git config --global user.name "fullstack-agent[bot]"
          git config --global user.email "fullstack-agent[bot]@users.noreply.github.com"
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
      - name: Run Fullstack Agent (with compliance knowledge)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          COMPLIANCE_MODE: "enabled"
        run: node fullstack-agent.js

  sre-agent:
    needs: [fullstack-agent]
    if: always()
    runs-on: ubuntu-latest
    name: SRE Agent (Code & Pipeline Fixes)
    permissions:
      contents: write
      actions: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Set up git credentials
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      - name: Run Agentic SRE Engineer
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node agentic_sre_engineer.js

  compliance-agent:
    needs: [unit-test, test-playwright, test-vitest, test-cypress]
    if: always()
    runs-on: ubuntu-latest
    name: Compliance Agent (Legal & Regulatory)
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run Compliance Audit
        run: npm run compliance-agent
      - name: Upload compliance report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compliance-audit-report
          path: compliance-audit-report.md
          retention-days: 90
      - name: Check for compliance critical issues
        run: |
          if grep -q "üî¥ Critical Issues.*must be resolved" compliance-audit-report.md; then
            echo "‚ö†Ô∏è  Compliance audit found critical issues"
            exit 0
          fi
          echo "‚úÖ Compliance audit passed"

  compliance-scan:
    runs-on: ubuntu-latest
    name: Accessibility & Security Compliance
    strategy:
      matrix:
        check: [accessibility, security]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Accessibility Scan (Pa11y)
        if: matrix.check == 'accessibility'
        id: pa11y
        run: |
          echo "Starting development server..."
          npm start > /tmp/server.log 2>&1 &
          SERVER_PID=$!
          sleep 5
          
          echo "Running Pa11y accessibility tests..."
          npm run test:pa11y || true
          
          kill $SERVER_PID 2>/dev/null || true
          
          if [ -f pa11y-report.json ]; then
            echo "Pa11y report generated"
          fi
        continue-on-error: true
      
      - name: Run Security Scan (npm audit)
        if: matrix.check == 'security'
        id: audit
        run: |
          echo "Running npm audit for security vulnerabilities..."
          npm audit --audit-level=moderate --json > audit-report.json || true
          
          if [ -f audit-report.json ]; then
            echo "Audit report generated"
            cat audit-report.json | jq '.metadata | {total, vulnerabilities, severity}'
          fi
        continue-on-error: true
      
      - name: Upload Pa11y Report
        if: matrix.check == 'accessibility' && always()
        uses: actions/upload-artifact@v4
        with:
          name: pa11y-report
          path: pa11y-report.json
          retention-days: 30
        continue-on-error: true
      
      - name: Upload Audit Report
        if: matrix.check == 'security' && always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-report
          path: audit-report.json
          retention-days: 30
        continue-on-error: true
      
      - name: Comment on PR - Accessibility Results
        if: matrix.check == 'accessibility' && github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## ‚ôø Accessibility Scan Results\n\n';
            
            if (fs.existsSync('pa11y-report.json')) {
              try {
                const report = JSON.parse(fs.readFileSync('pa11y-report.json', 'utf-8'));
                comment += '‚úÖ Pa11y scan completed\n';
              } catch (e) {
                comment += '‚ö†Ô∏è Pa11y report parsing failed\n';
              }
            } else {
              comment += '‚ö†Ô∏è No Pa11y report found\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Comment on PR - Security Results
        if: matrix.check == 'security' && github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## üîê Security Scan Results\n\n';
            
            if (fs.existsSync('audit-report.json')) {
              try {
                const report = JSON.parse(fs.readFileSync('audit-report.json', 'utf-8'));
                const metadata = report.metadata || {};
                comment += `Vulnerabilities: ${metadata.vulnerabilities || 0}\n`;
                comment += `Packages: ${metadata.packages || 0}\n`;
              } catch (e) {
                comment += '‚ö†Ô∏è Audit report parsing failed\n';
              }
            } else {
              comment += '‚úÖ No vulnerabilities found\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
  
  compliance-summary:
    needs: [compliance-scan]
    runs-on: ubuntu-latest
    name: Compliance Summary
    if: always()
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Generate Summary
        run: |
          echo "## üìä Compliance Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f pa11y-report/pa11y-report.json ]; then
            echo "‚úÖ **Accessibility Report Generated**" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f audit-report/audit-report.json ]; then
            echo "‚úÖ **Security Report Generated**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Reports available in artifacts for review" >> $GITHUB_STEP_SUMMARY