on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual trigger'
        required: false
        default: 'Manual workflow trigger'

jobs:
  lint:
    runs-on: ubuntu-latest
    name: Code Linting
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run ESLint
        run: npx eslint . --ext .js

  unit-test:
    needs: [lint]
    runs-on: ubuntu-latest
    name: Unit Tests
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run Jest unit tests
        run: npx jest --coverage

  test-playwright:
    needs: [lint]
    runs-on: ubuntu-latest
    name: Playwright Tests
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      - name: Run Playwright tests
        run: npx playwright test

  test-vitest:
    needs: [lint]
    runs-on: ubuntu-latest
    name: Vitest Tests
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run Vitest
        run: npm run test:vitest -- --run --coverage

  test-cypress:
    needs: [lint]
    runs-on: ubuntu-latest
    name: Cypress Tests
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Start server
        run: npm start &
      - name: Wait for server
        run: sleep 2
      - name: Run Cypress tests
        run: npm run test:cypress

  sdet-agent:
    needs: [unit-test, test-playwright, test-vitest, test-cypress]
    if: always()
    runs-on: ubuntu-latest
    name: SDET Agent (Manual UI Testing)
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium
      - name: Start server
        run: npm start &
      - name: Wait for server
        run: sleep 2
      - name: Run SDET Manual UI Testing
        run: |
          node << 'SDET_SCRIPT'
          const fs = require('fs');
          
          console.log('\nü§ñ SDET Agent: Manual UI Testing & Codebase Analysis\n');
          console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
          
          // Codebase Knowledge
          console.log('üìã Codebase Knowledge Assessment:\n');
          console.log('  ‚úì UI Framework: Node.js + Express');
          console.log('  ‚úì Frontend: Vanilla JavaScript (app.js)');
          console.log('  ‚úì Test Frameworks: Jest, Playwright, Cypress, Vitest');
          console.log('  ‚úì Architecture: MVC with Puppeteer backend\n');
          
          // Verify files
          console.log('üìÇ Critical Codebase Files:\n');
          const requiredFiles = ['public/app.js', 'public/index.html', 'server.js', 'qa-agent.js'];
          requiredFiles.forEach(file => {
            const exists = fs.existsSync(file);
            console.log(`  ${exists ? '‚úÖ' : '‚ùå'} ${file}`);
          });
          
          // UI Features
          console.log('\nüîç UI Functionality Verification:\n');
          const appCode = fs.readFileSync('public/app.js', 'utf8');
          const features = [
            ['Download Script Button', appCode.includes('downloadScript')],
            ['Copy to Clipboard', appCode.includes('copyToClipboard')],
            ['Tab Switching', appCode.includes('tab-button')],
            ['Scan Functionality', appCode.includes('scanBtn.addEventListener')],
            ['Empty State Handling', appCode.includes('No issues detected')]
          ];
          features.forEach(([name, exists]) => {
            console.log(`  ${exists ? '‚úÖ' : '‚ùå'} ${name}`);
          });
          
          console.log('\n‚úÖ SDET Agent Assessment Complete\n');
          SDET_SCRIPT

  fullstack-agent:
    needs: [sdet-agent]
    if: always()
    runs-on: ubuntu-latest
    name: Fullstack Agent (Code Fixes)
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Set up git credentials
        run: |
          git config --global user.name "fullstack-agent[bot]"
          git config --global user.email "fullstack-agent[bot]@users.noreply.github.com"
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
      - name: Run Fullstack Agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: node fullstack-agent.js

  sre-agent:
    needs: [fullstack-agent]
    if: always()
    runs-on: ubuntu-latest
    name: SRE Agent (Code & Pipeline Fixes)
    permissions:
      contents: write
      actions: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Set up git credentials
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      - name: Run Agentic SRE Engineer
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node agentic_sre_engineer.js