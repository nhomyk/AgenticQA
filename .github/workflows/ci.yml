on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual trigger'
        required: false
        default: 'Manual workflow trigger'
      run_type:
        description: 'Type of run (initial, retest, retry, manual)'
        required: false
        default: 'manual'
        type: choice
        options:
          - initial
          - retest
          - retry
          - manual
          - diagnostic
      run_chain_id:
        description: 'Run chain ID (for grouping reruns with their initial run)'
        required: false
        default: ''

# Concurrency strategy: Group by run_chain_id to allow parallel chains
# - Each initial run gets unique chain (run_id)
# - All reruns reference same chain_id
# - Different chains can run in parallel
# - Reruns within same chain are serial (cancel previous rerun)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event.inputs.run_chain_id || github.run_id }}
  cancel-in-progress: true

env:
  RUN_TYPE: ${{ github.event.inputs.run_type || 'initial' }}
  RUN_CHAIN_ID: ${{ github.event.inputs.run_chain_id || github.run_id }}

jobs:
  lint:
    runs-on: ubuntu-latest
    name: Code Linting
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run ESLint
        run: npx eslint . --ext .js

  unit-test:
    needs: [lint]
    runs-on: ubuntu-latest
    name: Unit Tests
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run Jest unit tests
        run: npx jest --coverage 2>&1 | tee jest-output.log
      - name: Save Jest failures
        if: failure()
        run: |
          mkdir -p test-failures
          if [ -f jest-output.log ]; then
            echo "JEST_FAILED=true" >> test-failures/summary.txt
            grep -i "error\|fail\|expected" jest-output.log >> test-failures/jest-errors.txt || true
          fi
      - name: Upload test failures
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failures
          path: test-failures/
          retention-days: 1

  test-playwright:
    needs: [lint]
    runs-on: ubuntu-latest
    name: Playwright Tests
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      - name: Run Playwright tests
        run: npx playwright test 2>&1 | tee playwright-output.log
      - name: Save Playwright failures
        if: failure()
        run: |
          mkdir -p test-failures
          if [ -f playwright-output.log ]; then
            echo "PLAYWRIGHT_FAILED=true" >> test-failures/summary.txt
            grep -i "error\|fail\|expected" playwright-output.log >> test-failures/playwright-errors.txt || true
          fi
      - name: Upload test failures
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failures
          path: test-failures/
          retention-days: 1

  test-vitest:
    needs: [lint]
    runs-on: ubuntu-latest
    name: Vitest Tests
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run Vitest
        run: npm run test:vitest -- --run --coverage 2>&1 | tee vitest-output.log
      - name: Save Vitest failures
        if: failure()
        run: |
          mkdir -p test-failures
          if [ -f vitest-output.log ]; then
            echo "VITEST_FAILED=true" >> test-failures/summary.txt
            grep -i "error\|fail\|expected" vitest-output.log >> test-failures/vitest-errors.txt || true
          fi
      - name: Upload test failures
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failures
          path: test-failures/
          retention-days: 1

  test-cypress:
    needs: [lint]
    runs-on: ubuntu-latest
    name: Cypress Tests
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Install Cypress Browsers
        run: npx cypress install
      - name: Start server
        run: npm start > /tmp/server.log 2>&1 &
        timeout-minutes: 1
      - name: Wait for server to be ready
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:3000 > /dev/null; then
              echo "‚úÖ Server is ready!"
              exit 0
            fi
            echo "Waiting for server... ($i/30)"
            sleep 1
          done
          echo "‚ùå Server did not start in time"
          cat /tmp/server.log
          exit 1
      - name: Run Cypress tests
        run: npx cypress run 2>&1 | tee cypress-output.log
        timeout-minutes: 2
      - name: Save Cypress failures
        if: failure()
        run: |
          mkdir -p test-failures
          if [ -f cypress-output.log ]; then
            echo "CYPRESS_FAILED=true" >> test-failures/summary.txt
            grep -i "error\|fail\|expected" cypress-output.log >> test-failures/cypress-errors.txt || true
          fi
      - name: Upload test failures
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failures
          path: test-failures/
          retention-days: 1

  test-pa11y:
    needs: [lint]
    runs-on: ubuntu-latest
    name: Pa11y Accessibility Tests
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Start server
        run: npm start > /tmp/server.log 2>&1 &
      - name: Wait for server
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:3000 > /dev/null; then
              echo "‚úÖ Server started"
              exit 0
            fi
            echo "Waiting for server... ($i/30)"
            sleep 1
          done
          echo "‚ùå Server did not start in time"
          cat /tmp/server.log
          exit 1
      - name: Run Pa11y accessibility tests
        run: npm run test:pa11y 2>&1 | tee pa11y-output.log
      - name: Save Pa11y failures
        if: failure()
        run: |
          mkdir -p test-failures
          if [ -f pa11y-output.log ]; then
            echo "PA11Y_FAILED=true" >> test-failures/summary.txt
            grep -i "error\|fail\|wcag" pa11y-output.log >> test-failures/pa11y-errors.txt || true
          fi
      - name: Upload test failures
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failures
          path: test-failures/
          retention-days: 1

  test-security-audit:
    needs: [lint]
    runs-on: ubuntu-latest
    name: Security & Dependency Audit
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run npm audit (dependencies)
        run: npm audit --audit-level=moderate 2>&1 | tee audit-output.log || true
      - name: Check audit results
        run: |
          if grep -q "high\|critical" audit-output.log; then
            echo "‚ö†Ô∏è Security vulnerabilities detected"
            cat audit-output.log
            exit 1
          fi
          echo "‚úÖ No critical vulnerabilities found"
      - name: Save audit failures
        if: failure()
        run: |
          mkdir -p test-failures
          cp audit-output.log test-failures/security-audit-errors.txt || true
      - name: Upload test failures
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failures
          path: test-failures/
          retention-days: 1

  sdet-agent:
    needs: [unit-test, test-playwright, test-vitest, test-cypress, test-pa11y, test-security-audit]
    if: always()
    runs-on: ubuntu-latest
    name: SDET Agent (Manual UI Testing)
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium
      - name: Start server
        run: npm start &
      - name: Wait for server
        run: sleep 2
      - name: Run SDET Manual UI Testing
        run: |
          node << 'SDET_SCRIPT'
          const fs = require('fs');
          
          console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
          console.log('‚ïë   üéØ SDET AGENT - EXPERT KNOWLEDGE    ‚ïë');
          console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
          
          // Display SDET Expertise
          console.log('üìö Role: SDET Engineer - Software Development Engineer in Test');
          console.log('         Manual UI testing + Codebase analysis + Test automation design\n');
          
          console.log('üéØ Core Expertise:');
          const expertise = [
            'Manual UI Testing - Real user workflow simulation',
            'Codebase Architecture Understanding - Know the system inside-out',
            'Test Automation Design - Design patterns for maintainable tests',
            'Cross-browser Compatibility - Verify consistent behavior',
            'Accessibility Testing - WCAG 2.1 compliance verification',
            'Performance Analysis - Response times and resource usage',
            'Error Discovery - Find edge cases and breaking scenarios'
          ];
          expertise.forEach(exp => console.log(`  ‚Ä¢ ${exp}`));
          
          console.log('\nüèóÔ∏è Codebase Knowledge:\n');
          console.log('  ‚úì UI Framework: Node.js + Express');
          console.log('  ‚úì Frontend: Vanilla JavaScript (app.js)');
          console.log('  ‚úì Test Frameworks: Jest, Playwright, Cypress, Vitest');
          console.log('  ‚úì Architecture: MVC with Puppeteer backend');
          console.log('  ‚úì UI Tabs: Overview, Features, Use Cases, Technical, Pricing\n');
          
          // Verify files
          console.log('üìÇ Critical Codebase Files Validation:\n');
          const requiredFiles = ['public/app.js', 'public/index.html', 'server.js', 'qa-agent.js'];
          const fileStatus = requiredFiles.map(file => {
            const exists = fs.existsSync(file);
            console.log(`  ${exists ? '‚úÖ' : '‚ùå'} ${file}`);
            return { file, exists };
          });
          const allFilesExist = fileStatus.every(f => f.exists);
          
          // UI Features
          console.log('\nüîç UI Functionality Verification:\n');
          const appCode = fs.readFileSync('public/app.js', 'utf8');
          const features = [
            ['Download Script Button', appCode.includes('downloadScript')],
            ['Copy to Clipboard', appCode.includes('copyToClipboard')],
            ['Tab Switching', appCode.includes('tab-button')],
            ['Scan Functionality', appCode.includes('scanBtn.addEventListener')],
            ['Empty State Handling', appCode.includes('No issues detected')]
          ];
          const passedFeatures = features.filter(f => f[1]).length;
          features.forEach(([name, exists]) => {
            console.log(`  ${exists ? '‚úÖ' : '‚ùå'} ${name}`);
          });
          
          console.log('\nüìä Testing Strategy:');
          console.log('  ‚Ä¢ Manual paths: Verify UI responsiveness and user experience');
          console.log('  ‚Ä¢ Automated paths: Edge cases, error handling, data validation');
          console.log('  ‚Ä¢ Integration: Cross-component workflows and API interactions');
          console.log('  ‚Ä¢ Accessibility: Keyboard navigation, screen reader compatibility\n');
          
          console.log('\nüìà Assessment Summary:');
          console.log(`  Files Present: ${fileStatus.filter(f => f.exists).length}/${requiredFiles.length}`);
          console.log(`  Features Verified: ${passedFeatures}/${features.length}`);
          console.log(`  Status: ${allFilesExist && passedFeatures === features.length ? '‚úÖ READY' : '‚ö†Ô∏è NEEDS ATTENTION'}\n`);
          
          console.log('‚úÖ SDET Agent Assessment Complete\n');
          SDET_SCRIPT

  fullstack-agent:
    needs: [sdet-agent, compliance-agent]
    if: always()
    runs-on: ubuntu-latest
    name: Fullstack Agent (Code & Compliance Fixes)
    permissions:
      contents: write
      actions: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Download test failure artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-failures
          path: ./test-failures
        continue-on-error: true
      - name: Download compliance audit report
        uses: actions/download-artifact@v4
        with:
          name: compliance-audit-report
          path: ./compliance-artifacts
        continue-on-error: true
      - name: Display downloaded artifacts
        run: |
          if [ -d test-failures ]; then
            echo "üì¶ Test failure artifacts downloaded:"
            ls -la test-failures/
            echo ""
            echo "Content preview:"
            find test-failures -type f -exec echo "--- {} ---" \; -exec head -5 {} \;
          else
            echo "No test failure artifacts found (tests may have passed)"
          fi
          if [ -d compliance-artifacts ]; then
            echo ""
            echo "üõ°Ô∏è  Compliance audit artifacts:"
            ls -la compliance-artifacts/
          fi
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Set up git credentials
        run: |
          git config --global user.name "fullstack-agent[bot]"
          git config --global user.email "fullstack-agent[bot]@users.noreply.github.com"
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
      - name: Run Fullstack Agent (with compliance knowledge)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          COMPLIANCE_MODE: "enabled"
        run: node fullstack-agent.js

  sre-agent:
    needs: [fullstack-agent]
    if: always()
    runs-on: ubuntu-latest
    name: SRE Agent (Code & Pipeline Fixes)
    permissions:
      contents: write
      actions: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Set up git credentials
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      - name: Run Agentic SRE Engineer
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node agentic_sre_engineer.js

  compliance-agent:
    needs: [unit-test, test-playwright, test-vitest, test-cypress]
    if: always()
    runs-on: ubuntu-latest
    name: Compliance Agent (Legal & Regulatory)
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run Compliance Audit
        run: npm run compliance-agent
      - name: Upload compliance report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compliance-audit-report
          path: compliance-audit-report.md
          retention-days: 90
      - name: Check for compliance critical issues
        run: |
          if grep -q "üî¥ Critical Issues.*must be resolved" compliance-audit-report.md; then
            echo "‚ö†Ô∏è  Compliance audit found critical issues"
            exit 0
          fi
          echo "‚úÖ Compliance audit passed"